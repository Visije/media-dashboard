<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="page" content="writer">
  <title>Script Tracker</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    body {
      background: #f7f8fc;
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #333;
    }
    nav {
      text-align: center;
      margin-bottom: 30px;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      font-weight: 600;
      color: #555;
    }
    .channel-card {
      background: white;
      margin-bottom: 30px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .channel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .progress-bar {
      background: #e3e6ef;
      border-radius: 8px;
      overflow: hidden;
      height: 10px;
      margin-bottom: 15px;
    }
    .progress-bar-inner {
      height: 100%;
      background: #6c5ce7;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    th {
      text-align: left;
      color: #555;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .Ready { background: #00b894; }
    .Writing { background: #fdcb6e; }
    .Pending { background: #d63031; }
  </style>
</head>

<body>

<header>
  <h1>‚úçÔ∏è Script Tracker</h1>
  <p style="text-align:center;">All channels ‚Ä¢ Ascend-style view</p>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="calendar.html">üìÖ Calendar</a>
  <a href="scripts.html">Scripts</a>
  <a href="goals.html">Daily Goals</a>
</nav>

<div id="tables"></div>

<script>
const sheetURL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTU4yNw1NlyydNT5CH3XZrGYyS27yZXuK6JKfID416K2nFSwtAznHjlYYySULRP7i8ktOIM54bxl2sn/pub?gid=0&single=true&output=csv";

const channels = [
  "Ender Vij",
  "I'm Gurey",
  "CRUST",
  "Zone-out History",
  "Touristico"
];

// SAFE CSV PARSER
function parseCSV(text) {
  const lines = text.split("\n").filter(l => l.trim());
  const rows = [];

  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    if (cols) rows.push(cols.map(c => c.replace(/^"|"$/g, "")));
  }
  return rows;
}

// WEEK RANGE
function getWeekRange(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return null;

  const day = d.getDay() || 7;
  const monday = new Date(d);
  monday.setDate(d.getDate() - day + 1);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);

  return `${monday.toISOString().slice(0,10)} ‚Üí ${sunday.toISOString().slice(0,10)}`;
}

// FETCH & RENDER
fetch(sheetURL)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);
    const container = document.getElementById("tables");
    container.innerHTML = "";

    const weekly = {};
    rows.forEach(r => {
      if (!r[4]) return;
      const week = getWeekRange(r[4]);
      if (!weekly[week]) weekly[week] = [];
      weekly[week].push(r);
    });

    Object.keys(weekly).sort().reverse().forEach(week => {
      container.innerHTML += `<h2>üìÜ Week: ${week}</h2>`;

      channels.forEach(channel => {
        const channelRows = weekly[week].filter(r => r[1] === channel);
        if (!channelRows.length) return;

        const ready = channelRows.filter(r => r[2] === "Ready").length;
        const percent = Math.round((ready / channelRows.length) * 100);

        container.innerHTML += `
          <div class="channel-card">
            <div class="channel-header">
              <strong>${channel}</strong>
              <span>${percent}% Ready</span>
            </div>

            <div class="progress-bar">
              <div class="progress-bar-inner" style="width:${percent}%"></div>
            </div>

            <table>
              <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Words</th>
                <th>Date</th>
              </tr>
              ${channelRows.map(r => `
                <tr>
                  <td>${r[0]}</td>
                  <td><span class="badge ${r[2]}">${r[2]}</span></td>
                  <td>${r[3]}</td>
                  <td>${r[4]}</td>
                </tr>
              `).join("")}
            </table>
          </div>
        `;
      });
    });
  })
  .catch(err => {
    console.error(err);
    document.getElementById("tables").innerHTML =
      "<p style='color:red'>‚ùå Error loading scripts</p>";
  });
</script>

</body>
</html>
