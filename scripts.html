<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="page" content="writer">
  <title>Script Tracker</title>
  <link rel="stylesheet" href="css/scripts.css">
</head>

<body>

<!-- ROLE HANDLING -->
<script>
(function () {
  const role = localStorage.getItem("role");

  // If someone tries to access scripts without role, force selection
  if (!role) {
    location.href = "index.html";
  }
})();
</script>

<header>
  <h1>Script Tracker</h1>
  <p class="subtitle">All channels ‚Ä¢ Ascend-style weekly view</p>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="calendar.html">Calendar</a>
  <a href="scripts.html" class="active">Scripts</a>
  <a href="goals.html">Daily Goals</a>
</nav>

<div id="tables"></div>

<script>
/* ================= CONFIG ================= */

const sheetURL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTU4yNw1NlyydNT5CH3XZrGYyS27yZXuK6JKfID416K2nFSwtAznHjlYYySULRP7i8ktOIM54bxl2sn/pub?gid=0&single=true&output=csv";

const channels = [
  "Ender Vij",
  "I'm Gurey",
  "CRUST",
  "Zone-out History",
  "Touristico"
];

/* ================= HELPERS ================= */

// Safe CSV parser (handles commas in titles)
function parseCSV(text) {
  const lines = text.split("\n").filter(l => l.trim());
  const rows = [];

  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    if (cols) rows.push(cols.map(c => c.replace(/^"|"$/g, "")));
  }
  return rows;
}

// Convert date ‚Üí Monday‚ÄìSunday range
function getWeekRange(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return null;

  const day = d.getDay() || 7;
  const monday = new Date(d);
  monday.setDate(d.getDate() - day + 1);

  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);

  return `${monday.toISOString().slice(0,10)} ‚Üí ${sunday.toISOString().slice(0,10)}`;
}

/* ================= RENDER ================= */

fetch(sheetURL)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);
    const container = document.getElementById("tables");
    container.innerHTML = "";

    // Group by week
    const weekly = {};
    rows.forEach(r => {
      if (!r[4]) return;
      const week = getWeekRange(r[4]);
      if (!weekly[week]) weekly[week] = [];
      weekly[week].push(r);
    });

    // Render latest week first
    Object.keys(weekly).sort().reverse().forEach(week => {
      container.innerHTML += `<h2>üìÜ Week: ${week}</h2>`;

      channels.forEach(channel => {
        const channelRows = weekly[week].filter(r => r[1] === channel);
        if (!channelRows.length) return;

        const readyCount = channelRows.filter(r => r[2] === "Ready").length;
        const percent = Math.round((readyCount / channelRows.length) * 100);

        container.innerHTML += `
          <div class="channel-card">
            <div class="channel-header">
              <span>${channel}</span>
              <span>${percent}% Ready</span>
            </div>

            <div class="progress-bar">
              <div class="progress-bar-inner" style="width:${percent}%"></div>
            </div>

            <table>
              <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Words</th>
                <th>Date</th>
              </tr>

              ${channelRows.map(r => `
                <tr>
                  <td>${r[0]}</td>
                  <td><span class="badge ${r[2]}">${r[2]}</span></td>
                  <td>${r[3]}</td>
                  <td>${r[4]}</td>
                </tr>
              `).join("")}
            </table>
          </div>
        `;
      });
    });
  })
  .catch(() => {
    document.getElementById("tables").innerHTML =
      "<p style='color:red'>‚ùå Error loading scripts</p>";
  });
</script>

</body>
</html>


