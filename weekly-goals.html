<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weekly Habit & Goal Tracker</title>

<style>
body{
  background:#f6f8fc;
  font-family:"Segoe UI",sans-serif;
  padding:20px;
  color:#222;
}
h1{margin-bottom:10px}

.top{
  display:grid;
  grid-template-columns:2fr 3fr;
  gap:20px;
}

.card{
  background:#fff;
  padding:16px;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
  margin-bottom:20px;
}

.ring{
  width:90px;height:90px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:18px;
  margin:10px 0;
  background:conic-gradient(#6ab04c 0%,#eaeaea 0);
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:6px;
  text-align:center;
  border-bottom:1px solid #eee;
}
th:first-child,td:first-child{text-align:left}

.days{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:12px;
  margin-top:20px;
}

.day-card{
  background:#fff;
  border-radius:14px;
  padding:12px;
  text-align:center;
  box-shadow:0 6px 16px rgba(0,0,0,.05);
}

/* ===== Coins ===== */
.coin{
  width:20px;height:20px;
  border-radius:50%;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:10px;
  font-weight:600;
}
.bronze{background:linear-gradient(145deg,#cd7f32,#b87333);color:#3a220f}
.silver{background:linear-gradient(145deg,#e6e6e6,#bfc1c2);color:#333}
.gold{background:linear-gradient(145deg,#ffd700,#f5c542);color:#4a3b00}

input[type=checkbox]{transform:scale(1.1);cursor:pointer}
select{padding:6px 10px;border-radius:8px}
</style>
</head>

<body>

<h1>ðŸ“… Weekly Execution Dashboard</h1>

<!-- WEEK SELECTOR -->
<select id="weekSelector"></select>

<div class="top">

<!-- OVERALL -->
<div class="card">
  <h3>Overall Progress</h3>
  <div class="ring" id="overallPercent">0%</div>
  <p id="overallCount">0 / 0 completed</p>
</div>

<!-- HABITS -->
<div class="card">
  <h3>Habit Tracker</h3>
  <table id="habitTable">
    <tr>
      <th>Habit</th>
      <th>Mon</th><th>Tue</th><th>Wed</th>
      <th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
      <th>Streak</th>
    </tr>
  </table>
</div>

</div>

<!-- DAY RINGS -->
<div class="days">
  <div class="day-card"><strong>Mon</strong><div class="ring" id="ring-Mon">0%</div></div>
  <div class="day-card"><strong>Tue</strong><div class="ring" id="ring-Tue">0%</div></div>
  <div class="day-card"><strong>Wed</strong><div class="ring" id="ring-Wed">0%</div></div>
  <div class="day-card"><strong>Thu</strong><div class="ring" id="ring-Thu">0%</div></div>
  <div class="day-card"><strong>Fri</strong><div class="ring" id="ring-Fri">0%</div></div>
  <div class="day-card"><strong>Sat</strong><div class="ring" id="ring-Sat">0%</div></div>
  <div class="day-card"><strong>Sun</strong><div class="ring" id="ring-Sun">0%</div></div>
</div>

<!-- WEEKLY REVIEW -->
<div class="card">
  <h3>Sunday Weekly Review</h3>
  <p><strong>Weekly Score:</strong> <span id="weekScore">--</span>/100</p>
  <h4>Wins</h4><p id="wins"></p>
  <h4>Improvements</h4><p id="improve"></p>
  <h4>Notes</h4><p id="notes"></p>
</div>

<script>
/* ===== CONFIG ===== */
const HABITS_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vS6HQvMdJhXvbseQFWwqFgy2jdGckYGNvRIzlYL30Lsbosk6Nxkm5jW172eeOEaAfjahHDhbYzxHYYL/pub?gid=1148852579&single=true&output=csv";

const TASKS_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vS6HQvMdJhXvbseQFWwqFgy2jdGckYGNvRIzlYL30Lsbosk6Nxkm5jW172eeOEaAfjahHDhbYzxHYYL/pub?gid=774223864&single=true&output=csv";

const REVIEW_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vS6HQvMdJhXvbseQFWwqFgy2jdGckYGNvRIzlYL30Lsbosk6Nxkm5jW172eeOEaAfjahHDhbYzxHYYL/pub?gid=0&single=true&output=csv";

const FORM_URL =
"https://docs.google.com/forms/d/e/1FAIpQLScsq34Fh-iefgnZECMNtYvyCuYW0dWiYJG5Lx4ngottl9YgSw/formResponse";

const DAYS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

/* ===== HELPERS ===== */
function parseCSV(t){return t.trim().split("\n").slice(1).map(r=>r.split(","));}

function setRing(el,p){
  el.style.background=`conic-gradient(#6ab04c ${p}%,#eaeaea 0)`;
  el.innerText=p+"%";
}

function getISOWeek(){
  const d=new Date();
  d.setDate(d.getDate()+3-(d.getDay()+6)%7);
  const week1=new Date(d.getFullYear(),0,4);
  const weekNo=1+Math.round(((d-week1)/86400000-3+(week1.getDay()+6)%7)/7);
  return d.getFullYear()+"-W"+String(weekNo).padStart(2,"0");
}

function getStreak(vals){
  let s=0;
  for(let i=vals.length-1;i>=0;i--){
    if(vals[i]==="TRUE") s++;
    else break;
  }
  return s;
}

function streakCoin(s){
  if(s>=21) return '<span class="coin gold">21</span>';
  if(s>=7)  return '<span class="coin silver">7</span>';
  if(s>=3)  return '<span class="coin bronze">3</span>';
  return "";
}

function updateHabit(habit,day,val){
  const d=new FormData();
  d.append("entry.129852130",habit);
  d.append("entry.1541899312",day);
  d.append("entry.1645968702",val?"TRUE":"FALSE");
  fetch(FORM_URL,{method:"POST",mode:"no-cors",body:d});
}

/* ===== MAIN ENGINE ===== */
const CURRENT_WEEK=getISOWeek();

Promise.all([
  fetch(HABITS_CSV).then(r=>r.text()),
  fetch(TASKS_CSV).then(r=>r.text()),
  fetch(REVIEW_CSV).then(r=>r.text())
]).then(([hText,tText,rText])=>{

  const habits=parseCSV(hText);
  const tasks=parseCSV(tText);
  const reviews=parseCSV(rText);

  const weeks=[...new Set(habits.map(r=>r[0]))].sort().reverse();
  const selector=document.getElementById("weekSelector");

  weeks.forEach(w=>{
    const o=document.createElement("option");
    o.value=w;o.textContent=w;
    if(w===CURRENT_WEEK) o.selected=true;
    selector.appendChild(o);
  });

  selector.onchange=()=>loadWeek(selector.value);
  loadWeek(selector.value);

  function loadWeek(week){
    habitTable.innerHTML=habitTable.rows[0].outerHTML;

    let weeklyDone=0,weeklyTotal=0;
    const stats={};DAYS.forEach(d=>stats[d]={done:0,total:0});

    habits.filter(r=>r[0]===week).forEach(row=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${row[1]}</td>`;
      const vals=row.slice(2);

      DAYS.forEach((d,i)=>{
        const v=vals[i];
        let cell="";
        if(v!==""){
          weeklyTotal++;stats[d].total++;
          if(v==="TRUE"){weeklyDone++;stats[d].done++}
          cell=`<input type="checkbox" ${v==="TRUE"?"checked":""}
          ${week!==CURRENT_WEEK?"disabled":""}
          onchange="updateHabit('${row[1]}','${d}',this.checked)">`;
        }
        tr.innerHTML+=`<td>${cell}</td>`;
      });

      tr.innerHTML+=`<td>${streakCoin(getStreak(vals))}</td>`;
      habitTable.appendChild(tr);
    });

    tasks.filter(r=>r[0]===week).forEach(([_,day,,done])=>{
      weeklyTotal++;stats[day].total++;
      if(done==="TRUE"){weeklyDone++;stats[day].done++}
    });

    const p=weeklyTotal?Math.round((weeklyDone/weeklyTotal)*100):0;
    setRing(overallPercent,p);
    overallCount.innerText=`${weeklyDone} / ${weeklyTotal} completed`;

    DAYS.forEach(d=>{
      const dp=stats[d].total?Math.round((stats[d].done/stats[d].total)*100):0;
      setRing(document.getElementById("ring-"+d),dp);
    });

    const rev=reviews.find(r=>r[0]===week);
    if(rev){
      weekScore.innerText=rev[1];
      wins.innerText=rev[2];
      improve.innerText=rev[3];
      notes.innerText=rev[4];
    }else{
      weekScore.innerText="--";
      wins.innerText="";improve.innerText="";notes.innerText="";
    }
  }
});
</script>

</body>
</html>
